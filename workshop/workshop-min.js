;(function($,f){'use strict';var g='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';$.fn.imagesLoaded=function(d){var e=this,deferred=$.isFunction($.Deferred)?$.Deferred():0,hasNotify=$.isFunction(deferred.notify),$images=e.find('img').add(e.filter('img')),loaded=[],proper=[],broken=[];function doneLoading(){var a=$(proper),$broken=$(broken);if(deferred){if(broken.length){deferred.reject($images,a,$broken)}else{deferred.resolve($images)}}if($.isFunction(d)){d.call(e,$images,a,$broken)}}function imgLoaded(a,b){if(a.src===g||$.inArray(a,loaded)!==-1){return}loaded.push(a);if(b){broken.push(a)}else{proper.push(a)}$.data(a,'imagesLoaded',{isBroken:b,src:a.src});if(hasNotify){deferred.notifyWith($(a),[b,$images,$(proper),$(broken)])}if($images.length===loaded.length){setTimeout(doneLoading);$images.unbind('.imagesLoaded')}}if(!$images.length){doneLoading()}else{$images.bind('load.imagesLoaded error.imagesLoaded',function(a){imgLoaded(a.target,a.type==='error')}).each(function(i,a){var b=a.src;var c=$.data(a,'imagesLoaded');if(c&&c.src===b){imgLoaded(a,c.isBroken);return}if(a.complete&&a.naturalWidth!==f){imgLoaded(a,a.naturalWidth===0||a.naturalHeight===0);return}if(a.readyState||a.complete){a.src=g;a.src=b}})}return deferred?deferred.promise(e):e}})(jQuery);var multidrag={};multidrag.register=function(b,c){var d,touchX,touchY,mouseHandler;d=null;mouseHandler=null;b.bind('touchstart',function(e){var a,touches;a=d;touches=e.originalEvent.touches;if(touches.length===1&&!a){touchX=touches[0].pageX;touchY=touches[0].pageY;e.pageX=touchX;e.pageY=touchY;a=new c(e);d=a}});b.bind('touchmove',function(e){var a,touches;a=d;touches=e.originalEvent.touches;if(a&&touches.length>0){touchX=touches[0].pageX;touchY=touches[0].pageY;if(a.onDrag){e.pageX=touchX;e.pageY=touchY;a.onDrag(e)}}});b.bind('touchend',function(e){var a;handler=d;a=e.originalEvent.changedTouches;if(handler&&a.length>=1&&a[0].pageX===touchX&&a[0].pageY===touchY){d=null;if(handler.onRelease){e.pageX=touchX;e.pageY=touchY;handler.onRelease(e)}}});b.mousedown(function(e){var a;a=mouseHandler;if(!a){a=new c(e);mouseHandler=a}});b.mousemove(function(e){var a;a=mouseHandler;if(a&&a.onDrag){a.onDrag(e)}});b.mouseup(function(e){var a;a=mouseHandler;if(a){mouseHandler=null;if(a.onRelease){a.onRelease(e)}}})};var Circuit={};(function(j,$){"use strict";function removeArray(a,b){var i;for(i=a.length-1;i>=0;i-=1){if(a[i]===b){a.splice(i,1)}}}j.Connection=function(a,x,y,b,c){this.id=-1;this.input=a;this.x=x;this.y=y;this.dx=b;this.dy=c;this.elt=null;this.conns=[];this.stub=null;this.circ=null;this.line=null};j.ElementType=function(a,b,c,d,e,f,g,h,i){this.id=a;this.imgName=b;this.imgX=c;this.imgY=d;this.imgWidth=e;this.imgHeight=f;this.conns=g;this.propagate=h;this.poke=i||function(){return false}};j.Element=function(c,x,y){var d,conns;this.id=-1;this.type=c;this.x=x;this.y=y;this.imgElt=null;d=this;conns=[];$.each(c.conns,function(i,a){var b=new j.Connection(a.input,a.x,a.y,a.dx,a.dy);b.elt=d;conns.push(b)});this.conns=conns};j.Element.prototype.propagate=function(a){this.type.propagate(this,a)};j.Layout=function(){this.maxEltId=-1;this.maxConnId=-1;this.elts=[]};j.Layout.prototype.addElement=function(b){var c;c=this.maxEltId+1;this.maxEltId=c;b.id=c;c=this.maxConnId;$.each(b.conns,function(i,a){c+=1;a.id=c});this.maxConnId=c;this.elts.push(b)};j.Layout.prototype.removeElement=function(a){removeArray(this.elts,a)};j.Layout.prototype.addWire=function(a,b){var t;if(a.input===b.input){if(a.input){throw new Error('Cannot connect inputs');}else{throw new Error('Cannot connect outputs');}}if($.inArray(a.conns,b)<0){a.conns.push(b)}if($.inArray(b.conns,a)<0){b.conns.push(a)}};j.Layout.prototype.removeWire=function(a,b){removeArray(a.conns,b);removeArray(b.conns,a)}}(Circuit,jQuery||$));(function(e,$){"use strict";function getValue(a,b){if(a.input){if(a.conns.length===0){return false}else{return b.hasOwnProperty(a.conns[0].id)}}else{return b.hasOwnProperty(a.id)}}e.Evaluator=function(a){this.layout=a;this.trues={}};e.Evaluator.prototype.evaluate=function(c){var d,state,dirty,iters,anyDirty,id,conns,i,j,set;d={};$.each(this.trues,function(a,b){d[a]=b});state=new e.State(this.layout,d);dirty={};$.each(this.layout.elts,function(i,a){dirty[a.id]=a});for(iters=0;iters<50;iters+=1){anyDirty=false;state.sets=[];for(id in dirty){if(dirty.hasOwnProperty(id)){anyDirty=true;dirty[id].propagate(state)}}if(!anyDirty){break}dirty={};for(i=0;i<state.sets.length;i+=1){set=state.sets[i];if(getValue(set.conn,d)!==set.val){state.repaintConns[set.conn.id]=set.conn;if(set.val){d[set.conn.id]=1}else{delete d[set.conn.id]}conns=set.conn.conns;for(j=0;j<conns.length;j+=1){dirty[conns[j].elt.id]=conns[j].elt}}}}this.trues=d;return state};e.State=function(b,c){var d;d=false;$.each(b.elts,function(i,a){if(a.type.id==='out'){d=getValue(a.conns[0],c)}});this.layout=b;this.trues=c;this.accept=d;this.sets=[];this.repaintConns={}};e.State.prototype.getValue=function(a){return getValue(a,this.trues)};e.State.prototype.setValue=function(a,b){if(a.input){throw new Error('Cannot set value for input');}else{this.sets.push({conn:a,val:b})}}}(Circuit,jQuery||$));(function(e,$){"use strict";var f=3;var g=3;function setterImage(c){return function(a){var b='resource/'+a+'.png';if(c.imgElt.attr('src')!==b){c.imgElt.attr('src',b)}}}e.DrawCirc={};e.DrawCirc.createElement=function(b,c){var d,offs0,img;if(c.imgElt){c.imgElt.remove()}d=c.type;offs0=b.canvas.offset();img=$('<img></img>').addClass('on_canvas');c.imgElt=img;c.setImage=setterImage(c);c.setImage(d.imgName);img.width(d.imgWidth);img.height(d.imgHeight);img.offset({left:offs0.left+c.x+c.type.imgX,top:offs0.top+c.y+c.type.imgY});b.canvas.append(img);$.each(c.conns,function(i,a){e.DrawCirc.createStub(b,a)})};e.DrawCirc.removeElement=function(b,c){$.each(c.conns,function(i,a){if(a.circ!==null){a.circ.remove()}if(a.stub!==null){a.stub.remove()}});c.imgElt.remove()};e.DrawCirc.repositionElement=function(b,c){var d,offs0,img;d=c.type;offs0=b.canvas.offset();c.imgElt.offset({left:offs0.left+c.x+c.type.imgX,top:offs0.top+c.y+c.type.imgY});$.each(c.conns,function(i,a){e.DrawCirc.createStub(b,a)})};e.DrawCirc.createStub=function(a,b){var c,cy,dx,dy;if(b.circ!==null){b.circ.remove()}if(b.stub!==null){b.stub.remove()}c=b.elt.x+b.x;cy=b.elt.y+b.y;dx=c+b.dx;dy=cy+b.dy;if(b.input){b.circ=a.paper.circle(c,cy,g)}else{b.circ=a.paper.circle(c,cy,g);b.circ.attr('fill','black')}if(b.circ!==null){if(b.dx>0){c+=g}else if(b.dx<0){c-=g}if(b.dy>0){cy+=g}else if(b.dy<0){cy-=g}}b.stub=a.paper.path('M'+c+','+cy+'L'+dx+','+dy);b.stub.attr('stroke-width',f);if(b.conns.length>0){b.stub.hide();if(b.input){b.circ.hide()}}e.DrawCirc.recolorConnection(a,b)};e.DrawCirc.hideStub=function(a,b){if(b){b.stub.hide();if(b.circ){b.circ.hide()}}};e.DrawCirc.showStub=function(a,b){if(b){b.stub.show();if(b.circ){b.circ.show()}}};e.DrawCirc.createWire=function(a,b,c){var d,c1,x0,y0,x1,y1,line;if(b.input){d=c;c1=b}else{d=b;c1=c}x0=d.elt.x+d.x;y0=d.elt.y+d.y;x1=c1.elt.x+c1.x;y1=c1.elt.y+c1.y;line=a.paper.path('M'+(x0+d.dx)+','+(y0+d.dy)+'L'+x0+','+y0+'L'+x1+','+y1+'L'+(x1+c1.dx)+','+(y1+c1.dy));line.attr('stroke-width',f);line.attr('stroke-linecap','round');c1.line=line;e.DrawCirc.recolorConnection(a,d);return line};e.DrawCirc.recolorConnection=function(a,b){var d;if(a.state&&a.state.getValue(b)){d='#0A0'}else{d='#030'}if(b.stub){b.stub.attr('stroke',d)}if(b.circ){b.circ.attr('stroke',d);if(!b.input){b.circ.attr('fill',d)}}$.each(b.conns,function(i,c){if(c.stub){c.stub.attr('stroke',d)}if(c.circ){c.circ.attr('stroke',d)}if(c.line){c.line.attr('stroke',d)}})};e.DrawCirc.ghostWireToCoord=function(a,b,x,y){var c,y0,line;c=b.elt.x+b.x;y0=b.elt.y+b.y;line=a.paper.path('M'+(c+b.dx)+','+(y0+b.dy)+'L'+c+','+y0+'L'+x+','+y);line.attr('opacity',0.5);line.attr('stroke-width',f);return line};e.DrawCirc.ghostWireToConn=function(a,b,c){var d,y0,x1,y1,line;d=b.elt.x+b.x;y0=b.elt.y+b.y;x1=c.elt.x+c.x;y1=c.elt.y+c.y;line=a.paper.path('M'+(d+b.dx)+','+(y0+b.dy)+'L'+d+','+y0+'L'+x1+','+y1+'L'+(x1+c.dx)+','+(y1+c.dy));line.attr('opacity',0.5);line.attr('stroke-width',f);return line}}(Circuit,jQuery||$));(function(g,$){"use strict";function findConnection(e,x,y){var f,minConn;f=226;minConn=null;$.each(e.elts,function(i,c){var d,ey;d=c.x;ey=c.y;$.each(c.conns,function(j,a){var b,dy,d2;b=x-(d+a.x);dy=y-(ey+a.y);d2=b*b+dy*dy;if(d2<f){f=d2;minConn=a}})});return{d2:f,conn:minConn}}function findElement(c,x,y){var d;d=null;$.each(c.elts,function(i,a){var b,ey,type;b=x-a.x;ey=y-a.y;type=a.type;if(b>=type.imgX&&ey>=type.imgY&&b<type.imgX+type.imgWidth&&ey<type.imgY+type.imgHeight){d=a;return false}});return d}g.NullGesture=function(a){};g.NullGesture.prototype.mouseDown=function(a,e){var x,y,best,gest,elt;x=e.circuitX;y=e.circuitY;best=findConnection(a.layout,x,y);if(best.conn){if(best.conn.input&&best.conn.conns.length>0){a.showMessage('Input cannot be connected twice')}else{gest=new g.WiringGesture(a,best.conn);a.setGesture(gest);gest.mouseDrag(a,e)}}else{elt=findElement(a.layout,x,y);if(elt){if(elt.type.poke(elt,x-elt.x,y-elt.y)){a.circuitChanged()}else{}}}};g.NullGesture.prototype.mouseDrag=function(a,e){};g.NullGesture.prototype.mouseUp=function(a,e){};g.AddGesture=function(a,b,e){var c,x,y;this.type=b;this.elt=new g.Element(b,e.circuitX,e.circuitY);g.DrawCirc.createElement(a,this.elt)};g.AddGesture.prototype.isLegalPosition=function(a){var b,x,y,t,i,conn;b=this.elt;x=b.x;y=b.y;t=b.type;if(!a.isInside(x+t.imgX+t.imgWidth,y+t.imgY+t.imgHeight)||!a.isInside(x+t.imgX+t.imgWidth,y+t.imgY)||!a.isInside(x+t.imgX,y+t.imgY+t.imgHeight)||!a.isInside(x+t.imgX,y+t.imgY)){return false}for(i=b.conns.length-1;i>=0;i-=1){conn=b.conns[i];if(!a.isInside(x+conn.x,y+conn.y)){return false}}return true};g.AddGesture.prototype.mouseDrag=function(b,e){var c,poffs,legal;c=this.elt;c.x=e.circuitX;c.y=e.circuitY;g.DrawCirc.repositionElement(b,c);legal=this.isLegalPosition(b);if(legal){$(c.imgElt).stop().fadeTo(0,1.0)}else{$(c.imgElt).stop().fadeTo(0,0.5)}$.each(c.conns,function(i,a){if(a.circ!==null){if(legal){a.circ.attr('opacity',1.0)}else{a.circ.attr('opacity',0.5)}}if(a.stub!==null){if(legal){a.stub.attr('opacity',1.0)}else{a.stub.attr('opacity',0.5)}}})};g.AddGesture.prototype.mouseUp=function(a,e){var x,y,elt;elt=this.elt;if(this.isLegalPosition(a)){a.layout.addElement(elt);a.circuitChanged()}else{g.DrawCirc.removeElement(a,elt)}a.setGesture(null)};g.WiringGesture=function(a,b){this.conn0=b;this.conn1=null;this.line=g.DrawCirc.ghostWireToCoord(a,b,b.elt.x+b.dx,b.elt.y+b.dy);g.DrawCirc.hideStub(a,b)};g.WiringGesture.prototype.cancel=function(a){g.DrawCirc.showStub(a,this.conn0);g.DrawCirc.showStub(a,this.conn1);if(this.line){this.line.remove();this.line=null}};g.WiringGesture.prototype.mouseDrag=function(a,e){var b,c1old,c1,line;b=this.conn0;c1old=this.conn1;c1=findConnection(a.layout,e.circuitX,e.circuitY).conn;if(c1){if(b===c1){c1=null}else if(b.elt===c1.elt){c1=null;a.showMessage('Cannot connect element to itself')}else if(c1.input&&c1.conns.length>0){c1=null;a.showMessage('Input cannot be connected twice')}else if(b.input&&c1.input){c1=null;a.showMessage('Cannot connect inputs')}else if(!b.input&&!c1.input){c1=null;a.showMessage('Cannot connect outputs')}}if(c1!==c1old){if(this.line){this.line.remove()}g.DrawCirc.showStub(a,c1old);this.conn1=c1;if(c1){g.DrawCirc.hideStub(a,c1);this.line=g.DrawCirc.ghostWireToConn(a,b,c1)}}if(c1===null){line=this.line;if(line){line.remove()}this.line=g.DrawCirc.ghostWireToCoord(a,b,e.circuitX,e.circuitY)}};g.WiringGesture.prototype.mouseUp=function(a,e){var b,c1;b=this.conn0;c1=this.conn1;if(c1){if(b.input){b=this.conn1;c1=this.conn0}a.layout.addWire(b,c1);a.circuitChanged();g.DrawCirc.createWire(a,b,c1);g.DrawCirc.showStub(a,b);if(this.line){this.line.remove();this.line=null}this.conn0=null;this.conn1=null}else{g.DrawCirc.showStub(a,b);this.line.remove()}a.setGesture(null)}}(Circuit,jQuery||$));(function(h,$,j){"use strict";var k={'and':new h.ElementType('and','gateand',-60,-25,50,50,[new h.Connection(false,0,0,-10,0),new h.Connection(true,-70,-20,10,0),new h.Connection(true,-70,20,10,0)],function(a,b){b.setValue(a.conns[0],b.getValue(a.conns[1])&&b.getValue(a.conns[2]))}),'or':new h.ElementType('or','gateor',-60,-25,50,50,[new h.Connection(false,0,0,-10,0),new h.Connection(true,-70,-20,10,0),new h.Connection(true,-70,20,10,0)],function(a,b){b.setValue(a.conns[0],b.getValue(a.conns[1])||b.getValue(a.conns[2]))}),'not':new h.ElementType('not','gatenot',-40,-15,30,20,[new h.Connection(false,0,0,-10,0),new h.Connection(true,-50,0,10,0)],function(a,b){b.setValue(a.conns[0],!b.getValue(a.conns[1]))}),'in':new h.ElementType('in','switch0',-60,-25,50,50,[new h.Connection(false,0,0,-10,0)],function(a,b){b.setValue(a.conns[0],a.state||false)},function(a,x,y){if(x>=-45&&x<=-25&&y>=-15&&y<=15){a.state=!a.state;if(a.state){a.setImage('switch1')}else{a.setImage('switch0')}return true}else{return false}}),'out':new h.ElementType('out','output0',-30,-60,50,50,[new h.Connection(true,0,0,0,-10)],function(a,b){if(b.getValue(a.conns[0])){a.setImage('output1')}else{a.setImage('output0')}})};function fixEvent(a,e){var b;b=a.canvas.offset();e.circuitX=e.pageX-b.left;e.circuitY=e.pageY-b.top;return e}h.Workshop=function(d,f){var g,toolbar,canvas,name,gesture,info;g=this;d.addClass('circ-container');toolbar=$('<div></div>').addClass('circ-toolbar');canvas=$('<div></div>').addClass('circ-canvas');d.append(toolbar);d.append(canvas);this.toolbar=toolbar;this.canvas=canvas;this.gesture=new h.NullGesture(g);this.paper=j(canvas.get(0),canvas.width(),canvas.height());this.layout=new h.Layout();this.evaluator=new h.Evaluator(this.layout);this.state=this.evaluator.evaluate('');function GestureHandler(e){var c,ey,gest,newGest,toolOffs;e.preventDefault();c=e.pageX;ey=e.pageY;fixEvent(g,e);if(ey<canvas.offset().top){newGest=null;$('.tool',toolbar).each(function(i,a){var b,offs,dx,dy,type;b=$(a);offs=b.offset();dx=c-offs.left;dy=ey-offs.top;if(dx>=0&&dy>=0&&dx<b.width()&&dy<b.height()){type=k[b.attr('type')];newGest=new h.AddGesture(g,type,e);return false}});if(newGest){gest=g.gesture;g.gesture=newGest;if(gest&&gest.cancel){gest.cancel(g)}gest=newGest}}else{gest=g.gesture}if(gest.mouseDown){gest.mouseDown(g,e)}else{gest.mouseDrag(g,e)}}GestureHandler.prototype.onDrag=function(e){var a=g.gesture;e.preventDefault();if(a){fixEvent(g,e);a.mouseDrag(g,e)}};GestureHandler.prototype.onRelease=function(e){var a=g.gesture;e.preventDefault();if(a){fixEvent(g,e);a.mouseDrag(g,e);a.mouseUp(g,e)}};multidrag.register(d,GestureHandler)};h.Workshop.prototype.circuitChanged=function(){var c,state;c=this;state=c.evaluator.evaluate('');c.state=state;$.each(state.repaintConns,function(a,b){h.DrawCirc.recolorConnection(c,b)})};h.Workshop.prototype.isInside=function(x,y){var a;a=this.canvas;return x>=0&&y>=0&&x<a.width()&&y<a.height()};h.Workshop.prototype.showMessage=function(a){console.log(a)};h.Workshop.prototype.setGesture=function(a){var b;b=this.gesture;if(b&&b.cancel){b.cancel(this)}if(a===null){this.gesture=new h.NullGesture()}else{this.gesture=a}};h.Workshop.prototype.setTools=function(c){var d,toolbar;d=this;toolbar=this.toolbar;toolbar.empty();$.each(c,function(i,a){var b;if(k.hasOwnProperty(a)){b=k[a];toolbar.append($('<img></img>').addClass('tool').attr('src','resource/'+b.imgName+'.png').attr('type',b.id))}else{console.log('unknown tool type "'+a+'"')}});toolbar.imagesLoaded(function(){$('.tool').each(function(){var a=$(this);a.width(a.width()*0.2)})})};$(document).ready(function(){var a,workshop;a=$('#main');if(!a.hasClass('circ-container')){workshop=new h.Workshop(a);workshop.setTools(['and','or','not','in','out'])}})}(Circuit,jQuery||$,Raphael));
